properties([pipelineTriggers([githubPush()])])

pipeline {
    agent any
      options {
        skipStagesAfterUnstable()
    }
    stage('Checkout SCM') {
  steps {
    checkout([
      $class: 'GitSCM',
      branches: [[name: 'main']],
      userRemoteConfigs: [[
        url: 'git@github.com:NOKnowitAll/final-project-klavdievo.git',
        credentialsId: 'GitHub_credentials',
      ]]
     ])
   }
}
     
    
    
    stages {
      stage('Clone git repository') {
        steps {
          script {
	    git branch: 'main', credentialsId: 'GitHub_credentials', url: 'git@github.com:NOKnowitAll/final-project-klavdievo.git'
            sh "ls -la"
            }
        }
     }
     stage ('Copy final projects file to Target Server') {
       steps {
        sshagent(credentials : ['52169397-9702-4875-8bf0-43e190a70700']) {
            sh '''
              ssh -o StrictHostKeyChecking=no ubuntu@192.168.88.102 uptime
              ssh -v ubuntu@192.168.88.102
              ssh ubuntu@192.168.88.102 "mkdir -p /home/ubuntu/fp_klavdievo"
              scp -r ./* ubuntu@192.168.88.102:/home/ubuntu/fp_klavdievo
	      ssh ubuntu@192.168.88.102 "ls -la"
             '''
            }
         }
      }
      stage('Clone docker repository') {
        steps {
          script {
            git branch: 'main', credentialsId: 'GitHub_credentials', url: 'https://github.com/NOKnowitAll/jenkins-klavdievo.git'
            sh "ls -la"
            }
        }
     }
      stage('Build Docker Image'){
       steps {
         sshagent(credentials : ['52169397-9702-4875-8bf0-43e190a70700']) {
           sh '''
             ssh ubuntu@192.168.88.102 'yes | docker system prune --all --volumes'
             scp ./Dockerfile ubuntu@192.168.88.102:/home/ubuntu
             ssh ubuntu@192.168.88.102 "docker rm -f klavdievo"
	     ssh ubuntu@192.168.88.102 "docker build -t apache_image:$BUILD_ID ."
             ssh ubuntu@192.168.88.102 "docker run -d -p 80:80 -t --restart unless-stopped --name klavdievo apache_image:$BUILD_ID"
             '''
          }
       }
     }
    
    
    
  }
}
